apiVersion: fusion.tuna.ai/v1
kind: AgentEnvironment
metadata:
  name: env3
  namespace: tuna-fission
spec:
  engineType: Fission
  engineOptions:
    fission:
      poolSize: 3
      runtimeImage: robinqu/fission-a2a-python-env:1751352015
      builderImage: robinqu/fission-a2a-python-builder-env:1751272340

  endpoint:
    host: router.tuna-fission.svc.cluster.local
    protocol: http

  buildRecipe:
    buildScript: |-
      #!/bin/bash
      set -e
      set -x

      cd /tmp
      
      # download and unzip
      fission archive download --id="$FUNCTION_SOURCE_ARCHIVE_ID" -o src.zip
      mkdir src && unzip src.zip -d ./src
      
      # create deploy archive
      export SRC_PKG=/tmp/src
      cp $AGENT_CARD_JSON_PATH $SRC_PKG/agent_card.json
      if [ -f ${SRC_PKG}/requirements.txt ]; then
        uv pip install -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple -r ${SRC_PKG}/requirements.txt --target ${SRC_PKG}
      fi
      zip -jr deploy.zip ${SRC_PKG}/
      
      # create function and route
      if ! fission fn getmeta --name "$FUNCTION_NAME" -n "$NAMESPACE"; then
        echo "Function $FUNCTION_NAME does not exist. Creating it now..."      
        # Create the function
        fission fn create \
        -n "$NAMESPACE" \
        --name "$FUNCTION_NAME" \
        --env "$FUNCTION_ENV" \
        --src src.zip \
        --deploy deploy.zip \
        --entrypoint "app.handle"
      else
        echo "Function $FUNCTION_NAME is to be updated."
        fission fn update \
        -n "$NAMESPACE" \
        --name "$FUNCTION_NAME" \
        --env "$FUNCTION_ENV" \
        --src src.zip \
        --deploy deploy.zip \
        --entrypoint "app.handle"
      fi

      # Create route if necessary
      if ! fission route get --name "$ROUTE_NAME" -n "$NAMESPACE"; then
        echo "Route $ROUTE_NAME does not exist. Creating it now..."
        # Create the function
        fission route create \
          -n "$NAMESPACE" \
          --name "$ROUTE_NAME" \
          --method=GET \
          --method=POST \
          --function "$FUNCTION_NAME" \
          --url "$ROUTE_URL"
      else
        echo "Route $ROUTE_NAME already exists."
        fission route update \
          -n "$NAMESPACE" \
          --method=GET \
          --method=POST \
          --name "$ROUTE_NAME" \
          --function "$FUNCTION_NAME" \
          --url "$ROUTE_URL"
      fi

      echo "Testing fn"
      fission fn test -n "$NAMESPACE" --name "$FUNCTION_NAME" --subpath=/.well-known/agent.json

    builderImage: robinqu/tuna-fusion-toolchain:1751339595
    serviceAccountName: fission-user


