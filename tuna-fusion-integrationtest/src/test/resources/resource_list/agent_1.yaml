apiVersion: v1
kind: Namespace
metadata:
  name: tuna-fusion-test

---

apiVersion: v1
kind: ServiceAccount
metadata:
  name: fusion-builder-sa
  namespace: tuna-fusion-test
automountServiceAccountToken: true

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: fusion-builder-role
rules:
  - apiGroups:
      - fusion.tuna.ai
    resources:
      - podpools
      - podpools/status
      - podfunctions
      - podfunctions/status
      - podfunctionbuilds
      - podfunctionbuilds/status
    verbs:
      - get
      - list
      - create
      - update
      - delete
      - patch

---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: fusion-builder-binding
subjects:
  - kind: ServiceAccount
    name: fusion-builder-sa
    namespace: tuna-fusion-test
roleRef:
  kind: ClusterRole
  name: fusion-builder-role
  apiGroup: rbac.authorization.k8s.io

---

apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: shared-archive-pvc
spec:
  accessModes:
    - ReadWriteOnce
  volumeMode: Filesystem
  resources:
    requests:
      storage: 1Gi

---

apiVersion: fusion.tuna.ai/v1
kind: AgentEnvironment
metadata:
  name: env-1
  namespace: tuna-fusion-test
spec:
  driver:
    type: PodPool
    podPoolSpec:
      archivePvcName: shared-archive-pvc
      poolSize: 10
      builderImage: robinqu/fusion-a2a-env-builder:1753247400
      runtimeImage: robinqu/fusion-a2a-fastapi-runtime:1753247461
      builderPodServiceAccountName: fusion-builder-sa
      runPerPod: 100
      ttlPerPod: 86400

  executor:
    externalHost: localhost:8082
    protocol: http

---
apiVersion: fusion.tuna.ai/v1
kind: AgentDeployment
metadata:
  name: test-deploy-1
  namespace: tuna-fusion-test
spec:
  agentCard:
    name: hello-agent
    description: an A2A agent that speaks hello
    capabilities:
      streaming: true
      pushNotifications: false
      stateTransitionHistory: false
    defaultInputModes:
      - "text/plain"
      - "application/json"
    defaultOutputModes:
      - "application/json"
      - "image/png"
    skills:
      - description: "hello world"
        id: say_hello
        name: say hello
        tags:
          - hello
    provider:
      organization: tuna
      url: https://github.com/tuna-headquarter
    version: "1.0.0"
  environmentName: env-1
  git:
    watchedBranchName: "refs/heads/main"
  a2a:
    queueManager:
      provider: InMemory
    taskStore:
      provider: InMemory
  entrypoint: app.handle

---

apiVersion: fusion.tuna.ai/v1
kind: PodFunctionBuild
metadata:
  name: test-deploy-1-function-build-1
  namespace: tuna-fusion-test
spec:
  podFunctionName: test-deploy-1-function
  sourceArchive:
    httpZipSource:
      url: https://gist.github.com/RobinQu/bd00d0ac55f8bbfc269a90cfd04f0512/archive/0f88839098bc83a25f3f1e0e2b48fb509f9ae609.zip
      sha256Checksum: 53f4c76729bca42a5f29139aadc9e4481d0e0743a0c9a5c585cddf824d29c95f


