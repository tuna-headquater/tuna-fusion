apiVersion: fusion.tuna.ai/v1
kind: AgentEnvironment
metadata:
  name: env2
  namespace: tuna-fission
spec:
  engineType: Fission
  engineOptions:
    fission:
      builderImage: ghcr.io/fission/python-fastapi-builder
      poolSize: 3
      runtimeImage: ghcr.io/fission/python-fastapi-env
  buildRecipe:
    buildScript: |-
      #!/bin/bash
      set -e
      set -x

      cd /tmp

      fission archive download --id="$FUNCTION_SOURCE_ARCHIVE_ID" -o src.zip      

      if ! fission fn getmeta --name "$FUNCTION_NAME" -n "$NAMESPACE"; then
        echo "Function $FUNCTION_NAME does not exist. Creating it now..."      
        # Create the function
        fission fn create \
        -n "$NAMESPACE" \
        --name "$FUNCTION_NAME" \
        --env "$FUNCTION_ENV" \
        --src src.zip \
        --entrypoint "main.handler"
      else
        echo "Function $FUNCTION_NAME is to be updated."
        fission fn update \
        -n "$NAMESPACE" \
        --name "$FUNCTION_NAME" \
        --env "$FUNCTION_ENV" \
        --src src.zip \
        --entrypoint "main.handler"
      fi

      # Create route if necessary
      if ! fission route get --name "$ROUTE_NAME" -n "$NAMESPACE"; then
        echo "Route $ROUTE_NAME does not exist. Creating it now..."
        # Create the function
        fission route create \
        -n "$NAMESPACE" \
        --name "$ROUTE_NAME" \
        --function "$FUNCTION_NAME" \
        --url "/$CATALOGUE_NAME/$FUNCTION_NAME"
      else
        echo "Route $ROUTE_NAME already exists."
      fi

      echo "Testing fn"
      fission fn test -n "$NAMESPACE" --name "$FUNCTION_NAME"

    builderImage: robinqu/tuna-fusion-toolchain:1750673901
    serviceAccountName: fission-user

